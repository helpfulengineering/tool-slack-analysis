#!/bin/bash
OLD_DIRECTORY="$PWD"
cd -- "$(dirname -- "$0")"


if test -f ./token && (($(date -r ./token +%s) > $(date +%s) - 15 * 60)); then
    ./binary --session "$(cat ./token)" "$@"
    exit $?
fi


for ((count=0; count<2; count++)); do

CODE="$(
(/usr/bin/expect -f - 2>/dev/null | tr -d '[:space:]') <<EOD
    log_user 0
    spawn ./binary signin --raw "${ONEPASSWORD_SITE:-not set}" \
                                "${ONEPASSWORD_USER:-not set}" \
                                "${ONEPASSWORD_SECRET_KEY:-not set}" 
    expect ":"
    send "$ONEPASSWORD_PASSWORD\n"
    expect ":"
    send "$(mintotp <<< "$ONEPASSWORD_TOTP_SECRET")\n"
    expect "\n"
    log_user 1
    expect eof
EOD
)"

if (($(wc -c <<< "$CODE") == 44)); then
    echo "$CODE" > token
    cd "$OLD_DIRECTORY"
    bash "$BASH_SOURCE" "$@"
    exit $?
fi

done

echo "login error"
